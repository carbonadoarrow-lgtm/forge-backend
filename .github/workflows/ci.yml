name: forge-backend-ci
# Institutional Baseline v2 - Comprehensive CI Pipeline
# Target: 85/100+ (currently 40/100)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Phase 1: Security Scanning (fails fast)
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety

      - name: Check dependencies for vulnerabilities
        run: |
          if [ -f requirements.txt ]; then pip-audit -r requirements.txt || true; fi
          if [ -f requirements.txt ]; then safety check -r requirements.txt || true; fi

  # Phase 2: Type Checking
  typecheck:
    runs-on: ubuntu-latest
    needs: security
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run mypy
        run: |
          mypy src/ forge/ || true  # Don't fail yet, incremental adoption

  # Phase 3: Linting
  lint:
    runs-on: ubuntu-latest
    needs: security
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linting tools
        run: |
          pip install ruff black isort

      - name: Run ruff
        run: |
          ruff check src/ forge/ || true

      - name: Check formatting
        run: |
          black --check src/ forge/ || true
          isort --check src/ forge/ || true

  # Phase 4: Tests + Migrations
  test:
    runs-on: ubuntu-latest
    needs: [security, typecheck, lint]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Apply migrations
        env:
          FORGE_DB_PATH: ${{ runner.temp }}/forge_ci.db
        run: |
          python scripts/db/apply_migrations.py

      - name: Cockpit v2 operational proof (sqlite)
        env:
          FORGE_DB_PATH: ${{ runner.temp }}/forge_ci.db
        run: |
          python scripts/prove_cockpit_v2_operational.py

      - name: Run canonical test suite (D.8 + D.11 + D.12-A)
        run: |
          python -m pytest -q tests/test_acceptance_v2_direct.py tests/test_d11_failure_explicitness.py tests/test_d12a_read_endpoints.py --cov=src --cov=forge --cov-report=term --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
        continue-on-error: true  # Don't fail if codecov upload fails
